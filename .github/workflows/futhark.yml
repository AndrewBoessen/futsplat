name: Futhark CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Install Futhark (uses the official action)
      - name: Install Futhark
        run: |
          wget http://futhark-lang.org/releases/futhark-nightly-linux-x86_64.tar.xz
          tar xf futhark-nightly-linux-x86_64.tar.xz
          (cd futhark-nightly-linux-x86_64/ && PREFIX=$HOME/.local make install)
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # 3. Type-check all Futhark files in the engine directory
      - name: Check Futhark files
        run: futhark check engine/*.fut

      # 4. Run tests found in the engine directory
      - name: Run Futhark tests
        run: futhark test engine/tests.fut
